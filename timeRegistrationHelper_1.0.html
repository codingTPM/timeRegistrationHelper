<!DOCTYPE html>
<html>
    <head>
        <title>Excel Time Registration Helper</title>
        <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
        
        <!-- CSS Reset -->
        <style>
            *, *::before, *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            html {
                font-size: 16px;
                scroll-behavior: smooth;
            }

            body {
                line-height: 1.5;
                -webkit-font-smoothing: antialiased;
                font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            }

            img, picture, video, canvas, svg {
                display: block;
                max-width: 100%;
            }

            input, button, textarea, select {
                font: inherit;
            }

            p, h1, h2, h3, h4, h5, h6 {
                overflow-wrap: break-word;
            }
        </style>

        <!-- Custom CSS -->
        <style>
            .container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #ffffff;
                border-radius: 4px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            h1 {
                margin-bottom: 20px;
                color: #172849;
            }

            .upload-section {
                display: grid;
                gap: 20px;
                padding: 20px;
                text-align: center;
                margin-bottom: 20px;
            }

            input[type="file"] {
                padding: 8px;
                background-color: #f8f9fa;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: 100%;
            }

            button {
                padding: 10px 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }

            button:hover {
                background-color: #0056b3;
            }

            button:disabled {
                background-color: #cccccc;
                cursor: not-allowed;
            }

            .explainer {
                display: block;
                font-size: 0.8em;
                font-weight: normal;
                color: #666;
                margin-top: 2px;
            }

            body {
                background-color: #f5f5f5;
                padding: 40px 20px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Time Registration Helper</h1>
            <div class="upload-section">
                <input type="file" id="excelFile" accept=".xlsx, .xls">
                <button onclick="processExcel()">Generate Template</button>
            </div>
        </div>

        <script>
            function processExcel() {
                const file = document.getElementById('excelFile').files[0];
                if (!file) {
                    alert("Please select a file");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // Convert to array format
                        const rows = [['Day', 'Job Number', 'Task', 'Description', 'Time']];
                        const jobs = extractJobs(sheet);
                        
                        let startRow = 2; // First data row after header
                        
                        for (let day = 1; day <= 10; day++) {
                            // Add job rows
                            jobs.forEach(job => {
                                rows.push([
                                    `Day ${day}`,
                                    job.number,
                                    job.task,
                                    '',
                                    0
                                ]);
                            });
                            
                            // Add daily total row with Excel formula
                            rows.push([
                                `Day ${day} Total`,
                                '',
                                '',
                                '',
                                {
                                    t: 'n',
                                    f: `SUM(E${startRow}:E${startRow + jobs.length - 1})`
                                }
                            ]);
                            
                            // Add empty row (except after last day)
                            if (day < 10) {
                                rows.push(['', '', '', '', '']);
                            }
                            
                            // Update start row for next day's formula
                            startRow += jobs.length + 2; // jobs + total row + empty row
                        }

                        createWorkbook(rows);
                        
                    } catch (error) {
                        console.error("Error:", error);
                        alert("Error processing file");
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            function extractJobs(sheet) {
                const jobs = [];
                const range = XLSX.utils.decode_range(sheet['!ref']);
                
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({c: C, r: R});
                        const cell = sheet[cellAddress];
                        if (cell && cell.v) {
                            const cellValue = String(cell.v);
                            const match = cellValue.match(/^\d{5,10}$/);
                            if (match) {
                                const taskCell = sheet[XLSX.utils.encode_cell({c: C + 1, r: R})];
                                jobs.push({
                                    number: match[0],
                                    task: taskCell ? taskCell.v : ''
                                });
                            }
                        }
                    }
                }

                // Sort jobs by number in ascending order
                jobs.sort((a, b) => Number(a.number) - Number(b.number));

                return jobs;
            }

            function createWorkbook(rows) {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(rows);
                
                ws['!cols'] = [{width: 12}, {width: 15}, {width: 40}, {width: 50}, {width: 10}];
                
                ws['!autofilter'] = { ref: 'A1:E1' }; // Add filter to header row

                XLSX.utils.book_append_sheet(wb, ws, 'Time Registration');
                XLSX.writeFile(wb, 'time_registration.xlsx');
            }
        </script>
    </body>
</html>